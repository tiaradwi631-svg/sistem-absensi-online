<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SmartAttend - Sistem Absensi & Pesan (Final Report Fix)</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Supabase JS Library (JSDelivr) -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    
    <!-- Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Quicksand:wght@400;500;600;700&family=Great+Vibes&display=swap" rel="stylesheet">

    <style>
        body { font-family: 'Quicksand', sans-serif; background-color: #f0f4f8; }
        .font-aesthetic { font-family: 'Great Vibes', cursive; }
        .fade-in { animation: fadeIn 0.4s ease-out; }
        .scale-in { animation: scaleIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes scaleIn { from { opacity: 0; transform: scale(0.9); } to { opacity: 1; transform: scale(1); } }

        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; border-radius: 4px; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }

        video { transform: scaleX(-1); border-radius: 1rem; }
        .photo-result { transform: scaleX(-1); }
    </style>
</head>
<body class="text-slate-800 antialiased selection:bg-indigo-200">

    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useRef } = React;

        // --- KONFIGURASI SUPABASE (PERMANEN) ---
        const supabaseUrl = 'https://jypcwcykbnibjvuqlzyk.supabase.co'; 
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imp5cGN3Y3lrYm5pYmp2dXFsenlrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM4MTgxMjUsImV4cCI6MjA3OTM5NDEyNX0.NTOfDuaj9bmCp4ReVwyn3mCazLcx7qbSOZW9LuvEuJg';
        
        // --- UTILS ---
        const getTodayDate = () => new Date().toISOString().split('T')[0];
        const getCurrentTime = () => new Date().toLocaleTimeString('id-ID', { hour: '2-digit', minute: '2-digit' });
        
        const exportToCSV = (filename, rows) => {
            const processRow = (row) => row.map(val => {
                if (val === null || val === undefined) val = ''; 
                val = val.toString().replace(/"/g, '""'); 
                if (val.search(/("|,|\n)/g) >= 0) val = `"${val}"`;
                return val;
            }).join(',');
            const csvContent = "data:text/csv;charset=utf-8," + rows.map(processRow).join('\n');
            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", filename);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        };

        // --- ICONS ---
        const Icon = ({ children, className, onClick }) => (
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round" className={className} onClick={onClick}>
                {children}
            </svg>
        );

        const Icons = {
            Camera: (p) => <Icon {...p}><path d="M14.5 4h-5L7 7H4a2 2 0 0 0-2 2v9a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2V9a2 2 0 0 0-2-2h-3l-2.5-3z"/><circle cx="12" cy="13" r="3"/></Icon>,
            User: (p) => <Icon {...p}><path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></Icon>,
            Lock: (p) => <Icon {...p}><rect x="3" y="11" width="18" height="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></Icon>,
            LogOut: (p) => <Icon {...p}><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" y1="12" x2="9" y2="12"/></Icon>,
            Upload: (p) => <Icon {...p}><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></Icon>,
            Smile: (p) => <Icon {...p}><circle cx="12" cy="12" r="10"/><path d="M8 14s1.5 2 4 2 4-2 4-2"/><line x1="9" y1="9" x2="9.01" y2="9"/><line x1="15" y1="9" x2="15.01" y2="9"/></Icon>,
            X: (p) => <Icon {...p}><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></Icon>,
            File: (p) => <Icon {...p}><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/><polyline points="10 9 9 9 8 9"/></Icon>,
            Check: (p) => <Icon {...p}><polyline points="20 6 9 17 4 12"/></Icon>,
            Edit: (p) => <Icon {...p}><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></Icon>,
            Trash: (p) => <Icon {...p}><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/><line x1="10" y1="11" x2="10" y2="17"/><line x1="14" y1="11" x2="14" y2="17"/></Icon>,
            Download: (p) => <Icon {...p}><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></Icon>,
            Message: (p) => <Icon {...p}><path d="M21 11.5a8.38 8.38 0 0 1-.9 3.8 8.5 8.5 0 0 1-7.6 4.7 8.38 8.38 0 0 1-3.8-.9L3 21l1.9-5.7a8.38 8.38 0 0 1-.9-3.8 8.5 8.5 0 0 1 4.7-7.6 8.38 8.38 0 0 1 3.8-.9h.5a8.48 8.48 0 0 1 8 8v.5z"/></Icon>,
            Send: (p) => <Icon {...p}><line x1="22" y1="2" x2="11" y2="13"/><polygon points="22 2 15 22 11 13 2 9 22 2"/></Icon>,
            Eye: (p) => <Icon {...p}><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></Icon>,
            Alert: (p) => <Icon {...p}><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></Icon>,
            Clock: (p) => <Icon {...p}><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></Icon>,
            Trophy: (p) => <Icon {...p}><path d="M8 21h8"/><path d="M12 17v4"/><path d="M7 4H6a2 2 0 0 0-2 2v4a2 2 0 0 0 2 2h1"/><path d="M17 4h1a2 2 0 0 1 2 2v4a2 2 0 0 1-2 2h-1"/><path d="M6 4h12a2 2 0 0 1 2 2v6a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1-2-2z"/></Icon>
        };

        const MOTIVATION_QUOTES = [
            "Semangat! Masa depan cerah menantimu! üåü",
            "Rajin pangkal pandai, hemat pangkal kaya! üìö",
            "Hari ini harus lebih baik dari kemarin! üî•",
            "Jangan menyerah, kesuksesan sudah dekat! üöÄ",
            "Disiplin adalah jembatan antara cita-cita dan pencapaian. üåâ"
        ];

        const INITIAL_USERS = [
            { id: 1, username: 'admin', password: '123', role: 'admin', name: 'Admin Sekolah' }
        ];

        // --- UI COMPONENTS ---
        const Toast = ({ message, type, onClose }) => {
            useEffect(() => {
                const timer = setTimeout(onClose, 6000); 
                return () => clearTimeout(timer);
            }, [onClose]);

            return (
                <div className={`fixed top-6 left-1/2 -translate-x-1/2 z-[100] px-6 py-3 rounded-2xl shadow-2xl flex items-center gap-3 scale-in border-2 ${type === 'error' ? 'bg-red-50 border-red-100 text-red-600' : 'bg-emerald-50 border-emerald-100 text-emerald-600'}`}>
                    <span className="text-xl">{type === 'error' ? '‚ùå' : '‚úÖ'}</span>
                    <p className="font-bold text-sm">{message}</p>
                </div>
            );
        };

        const ConfirmModal = ({ isOpen, title, message, onConfirm, onCancel }) => {
            if (!isOpen) return null;
            return (
                <div className="fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center z-[90] p-4 fade-in">
                    <div className="bg-white rounded-3xl p-6 max-w-sm w-full shadow-2xl scale-in relative overflow-hidden">
                        <div className="absolute top-0 left-0 w-full h-2 bg-gradient-to-r from-pink-500 to-indigo-500"></div>
                        <h3 className="text-xl font-bold text-gray-800 mb-2">{title}</h3>
                        <p className="text-gray-600 mb-8 text-sm leading-relaxed">{message}</p>
                        <div className="flex gap-3 justify-end">
                            <button onClick={onCancel} className="px-5 py-2.5 bg-gray-100 hover:bg-gray-200 text-gray-600 rounded-xl font-bold text-sm transition">Batal</button>
                            <button onClick={onConfirm} className="px-5 py-2.5 bg-gradient-to-r from-indigo-600 to-indigo-700 text-white rounded-xl font-bold text-sm shadow-lg shadow-indigo-200 hover:scale-105 transition">Ya, Lanjutkan</button>
                        </div>
                    </div>
                </div>
            );
        };

        // 1. KAMERA MODAL
        const CameraCapture = ({ onCapture, onClose, title }) => {
            const videoRef = useRef(null);
            const canvasRef = useRef(null);
            const [error, setError] = useState('');

            useEffect(() => {
                let stream = null;
                const startCamera = async () => {
                    try {
                        stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "user" } });
                        if (videoRef.current) videoRef.current.srcObject = stream;
                    } catch (err) {
                        setError("Kamera tidak terdeteksi! Pastikan izin browser aktif.");
                    }
                };
                startCamera();
                return () => { if (stream) stream.getTracks().forEach(track => track.stop()); };
            }, []);

            const handleSnap = () => {
                if (!videoRef.current || !canvasRef.current) return;
                const width = 320;
                const height = (videoRef.current.videoHeight / videoRef.current.videoWidth) * width;
                canvasRef.current.width = width;
                canvasRef.current.height = height;
                const ctx = canvasRef.current.getContext('2d');
                ctx.translate(width, 0);
                ctx.scale(-1, 1);
                ctx.drawImage(videoRef.current, 0, 0, width, height);
                onCapture(canvasRef.current.toDataURL('image/jpeg', 0.7));
            };

            return (
                <div className="fixed inset-0 z-50 bg-black/90 flex items-center justify-center p-4 backdrop-blur-md fade-in">
                    <div className="bg-white rounded-3xl p-4 w-full max-w-md shadow-2xl relative overflow-hidden">
                        <div className="flex justify-between items-center mb-4 px-2">
                            <h3 className="font-bold text-lg text-gray-700 flex items-center gap-2"><Icons.Camera className="w-5 h-5 text-pink-500"/> {title}</h3>
                            <button onClick={onClose} className="p-2 bg-gray-100 rounded-full hover:bg-red-50 hover:text-red-500 transition"><Icons.X className="w-5 h-5"/></button>
                        </div>
                        {error ? <div className="bg-red-50 text-red-500 p-6 rounded-xl text-center font-medium border border-red-200 mb-4">{error}</div> : 
                        <div className="relative rounded-2xl overflow-hidden bg-black aspect-[4/3] shadow-inner mb-4 ring-4 ring-gray-100">
                            <video ref={videoRef} autoPlay playsInline className="w-full h-full object-cover"></video>
                            <canvas ref={canvasRef} className="hidden"></canvas>
                        </div>}
                        {!error && <div className="flex justify-center"><button onClick={handleSnap} className="bg-gradient-to-r from-pink-500 to-indigo-500 text-white px-8 py-3 rounded-full font-bold shadow-xl hover:scale-105 transition flex items-center gap-2"><Icons.Camera className="w-5 h-5"/> CEKREK & ABSEN</button></div>}
                    </div>
                </div>
            );
        };

        // 2. LOGIN
        const Login = ({ onLogin, users, showToast }) => {
            const [username, setUsername] = useState('');
            const [password, setPassword] = useState('');
            const [role, setRole] = useState('siswa'); 
            const [isLoading, setIsLoading] = useState(false);
            
            const handleSubmit = async (e) => {
                e.preventDefault();
                setIsLoading(true);
                const user = users.find(u => u.username === username && u.password === password && u.role === role);
                
                setIsLoading(false);
                if(user) {
                    onLogin(user);
                    showToast(`Selamat datang, ${user.name}!`, 'success');
                } else {
                    showToast('Username, Password, atau Role salah ya üôà', 'error');
                }
            };

            return (
                <div className="min-h-screen flex items-center justify-center bg-gradient-to-br from-indigo-100 via-purple-100 to-pink-100 p-6">
                    <div className="bg-white/80 backdrop-blur-xl p-8 rounded-[2.5rem] shadow-[0_20px_50px_rgba(8,_112,_184,_0.1)] w-full max-w-sm scale-in border border-white/50">
                        <div className="text-center mb-8">
                            <div className="inline-flex p-4 rounded-full bg-gradient-to-tr from-indigo-500 to-pink-500 text-white shadow-lg mb-4 transform hover:rotate-12 transition"><Icons.Smile className="w-10 h-10" /></div>
                            <h1 className="text-3xl font-bold bg-gradient-to-r from-indigo-600 to-pink-600 bg-clip-text text-transparent">SmartAttend</h1>
                            <p className="text-gray-500 text-lg font-bold mb-2 font-aesthetic text-indigo-400 mt-1">Absensi Modern Terpadu ‚ú®</p>
                        </div>

                        <div className="flex bg-gray-100 p-1.5 rounded-2xl mb-6 shadow-inner">
                            {['siswa', 'guru', 'admin'].map(r => (
                                <button key={r} onClick={() => setRole(r)} className={`flex-1 py-2.5 rounded-xl text-xs font-bold uppercase transition-all duration-300 ${role === r ? 'bg-white text-indigo-600 shadow-md scale-100' : 'text-gray-400 hover:text-gray-600 scale-95'}`}>{r}</button>
                            ))}
                        </div>

                        <form onSubmit={handleSubmit} className="space-y-5">
                            <div className="space-y-2">
                                <label className="text-xs font-bold text-gray-400 uppercase ml-1">Username</label>
                                <div className="relative group">
                                    <Icons.User className="absolute left-4 top-3.5 w-5 h-5 text-gray-400 group-focus-within:text-indigo-500 transition"/>
                                    <input type="text" value={username} onChange={e => setUsername(e.target.value)} className="w-full pl-12 pr-4 py-3.5 bg-gray-50 rounded-2xl focus:bg-white focus:ring-4 focus:ring-indigo-100 focus:outline-none transition font-medium text-gray-700" placeholder="username" required/>
                                </div>
                            </div>
                            <div className="space-y-2">
                                <label className="text-xs font-bold text-gray-400 uppercase ml-1">Password</label>
                                <div className="relative group">
                                    <Icons.Lock className="absolute left-4 top-3.5 w-5 h-5 text-gray-400 group-focus-within:text-pink-500 transition"/>
                                    <input type="password" value={password} onChange={e => setPassword(e.target.value)} className="w-full pl-12 pr-4 py-3.5 bg-gray-50 rounded-2xl focus:bg-white focus:ring-4 focus:ring-pink-100 focus:outline-none transition font-medium text-gray-700" placeholder="password" required/>
                                </div>
                            </div>
                            <button type="submit" disabled={isLoading} className="w-full bg-gray-900 text-white py-4 rounded-2xl font-bold text-lg shadow-xl shadow-gray-200 hover:bg-indigo-600 hover:shadow-indigo-200 transition-all hover:-translate-y-1 active:translate-y-0 mt-4 disabled:bg-gray-400">
                                {isLoading ? 'Memuat...' : 'Masuk Sekarang üöÄ'}
                            </button>
                        </form>
                    </div>
                </div>
            );
        };

        // 3. SISWA DASHBOARD
        const SiswaDashboard = ({ user, users, attendance, setAttendance, showToast, isActive, supabase }) => {
            const [activeTab, setActiveTab] = useState('absen'); 
            const [camMode, setCamMode] = useState(null);
            const [quote, setQuote] = useState('');
            const [leaveType, setLeaveType] = useState('sakit');
            const [file, setFile] = useState(null);
            const [note, setNote] = useState('');

            useEffect(() => { setQuote(MOTIVATION_QUOTES[Math.floor(Math.random() * MOTIVATION_QUOTES.length)]); }, []);

            const today = getTodayDate();
            const todayRecord = attendance.find(a => a.studentId === user.id && a.date === today);
            const hasClockedIn = todayRecord && todayRecord.type === 'hadir';
            const hasClockedOut = todayRecord && todayRecord.timeOut !== '-';

            const rankings = useMemo(() => {
                const students = users.filter(u => u.role === 'siswa');
                const stats = students.map(s => {
                    const count = attendance.filter(a => String(a.studentId) === String(s.id) && a.type === 'hadir' && a.approval === 'approved').length;
                    return { ...s, count };
                });
                return stats.sort((a, b) => b.count - a.count);
            }, [users, attendance]);

            const handleAbsenClick = (type) => {
                if (type === 'masuk') { 
                    if (todayRecord) return showToast("Sudah absen hari ini!", "error"); 
                } 
                else { 
                    if (!hasClockedIn) return showToast("Belum absen masuk!", "error"); 
                    if (hasClockedOut) return showToast("Sudah absen pulang!", "error"); 
                }
                setCamMode(type);
            };

            const handleCapture = async (photoData) => {
                setCamMode(null);
                try {
                    const newRecordBase = { id: Date.now(), studentId: user.id, date: today, approval: 'pending' };
                    
                    if (isActive && supabase) {
                        if (camMode === 'masuk') {
                            const record = { ...newRecordBase, type: 'hadir', timeIn: getCurrentTime(), timeOut: '-', status: 'Hadir', proof: photoData };
                            const { data, error } = await supabase.from('attendance').insert([record]).select();
                            if (error) throw error;
                            setAttendance([...attendance, data[0]]);
                            showToast("Absen Masuk Berhasil! (Online) üì∏", "success");
                        } else {
                            const updatedData = { timeOut: getCurrentTime(), proofOut: photoData };
                            const { data, error } = await supabase.from('attendance').update(updatedData).eq('id', todayRecord.id).select();
                            if (error) throw error;
                            setAttendance(attendance.map(a => a.id === todayRecord.id ? data[0] : a));
                            showToast("Absen Pulang Berhasil! (Online) üëã", "success");
                        }
                    } else {
                        if (camMode === 'masuk') {
                            const record = { ...newRecordBase, type: 'hadir', timeIn: getCurrentTime(), timeOut: '-', status: 'Hadir', proof: photoData };
                            setAttendance([...attendance, record]);
                            showToast("Absen Masuk Berhasil! (Demo Mode) üì∏", "success");
                        } else {
                            const updated = attendance.map(a => a.id === todayRecord.id ? { ...a, timeOut: getCurrentTime(), proofOut: photoData } : a);
                            setAttendance(updated);
                            showToast("Absen Pulang Berhasil! (Demo Mode) üëã", "success");
                        }
                    }
                } catch (err) {
                    console.error(err);
                    const errorMsg = err.message || "Gagal menyimpan.";
                    if (errorMsg.includes("row-level security")) {
                        showToast("Gagal: RLS Supabase Aktif. Matikan dulu RLS di Supabase.", "error");
                    } else {
                        showToast(`Error: ${errorMsg}`, "error");
                    }
                }
            };

            const handleSubmitLeave = async (e) => {
                e.preventDefault();
                if (todayRecord) return showToast("Anda sudah ada data hari ini!", "error");
                if (!file) return showToast("Wajib upload bukti surat ya!", "error");

                const reader = new FileReader();
                reader.onload = async (event) => {
                    const fileData = event.target.result; 
                    const newRecord = {
                        id: Date.now(),
                        studentId: user.id,
                        date: today,
                        type: leaveType,
                        timeIn: '-',
                        timeOut: '-',
                        status: leaveType.charAt(0).toUpperCase() + leaveType.slice(1),
                        proof: fileData, 
                        note: note,
                        approval: 'pending'
                    };

                    if (isActive && supabase) {
                        try {
                            const { data, error } = await supabase.from('attendance').insert([newRecord]).select();
                            if (error) throw error;
                            setAttendance([...attendance, data[0]]);
                            showToast("Izin Terkirim! (Online) üì®", "success");
                        } catch(err) {
                            const errorMsg = err.message || "Gagal kirim.";
                            if (errorMsg.includes("row-level security")) {
                                showToast("Gagal: RLS Supabase Aktif. Matikan dulu RLS.", "error");
                            } else {
                                showToast(`Error: ${errorMsg}`, "error");
                            }
                        }
                    } else {
                        setAttendance([...attendance, newRecord]);
                        showToast("Izin Terkirim! (Demo Mode) üì®", "success");
                    }
                    setFile(null); setNote('');
                };
                reader.readAsDataURL(file);
            };

            return (
                <div className="max-w-md mx-auto pb-20 fade-in">
                    <div className="bg-gradient-to-r from-amber-100 to-orange-100 border border-amber-200 p-5 rounded-3xl mb-6 shadow-sm flex items-start gap-4">
                        <span className="text-3xl filter drop-shadow-sm">üí°</span>
                        <div>
                            <p className="text-xs font-bold text-orange-600 uppercase mb-1 tracking-wider">Motivasi Hari Ini</p>
                            <p className="text-sm font-medium text-orange-900 italic leading-relaxed">"{quote}"</p>
                        </div>
                    </div>
                    
                    <div className="bg-white rounded-[2.5rem] p-6 shadow-xl shadow-indigo-50 mb-8 flex items-center gap-5 relative overflow-hidden border border-white">
                        <div className="absolute top-0 right-0 w-32 h-32 bg-gradient-to-br from-indigo-50 to-pink-50 rounded-bl-full opacity-50"></div>
                        <div className="w-16 h-16 rounded-2xl bg-indigo-100 flex items-center justify-center text-3xl shadow-inner text-indigo-600">üéì</div>
                        <div className="relative z-10">
                            <p className="text-gray-400 text-xs font-bold uppercase tracking-wide">Halo Siswa</p>
                            <h2 className="text-2xl font-bold text-gray-800">{user.name.split(' ')[0]}!</h2>
                            <span className="bg-indigo-50 text-indigo-600 px-2.5 py-1 rounded-lg text-xs font-bold mt-1 inline-block">{user.class}</span>
                        </div>
                    </div>

                    <div className="flex bg-white p-1.5 rounded-2xl shadow-sm border border-gray-100 mb-8">
                        <button onClick={() => setActiveTab('absen')} className={`flex-1 py-3 rounded-xl font-bold text-sm transition-all ${activeTab === 'absen' ? 'bg-indigo-50 text-indigo-600 shadow-sm' : 'text-gray-400 hover:text-gray-600'}`}>üì∏ Absen</button>
                        <button onClick={() => setActiveTab('izin')} className={`flex-1 py-3 rounded-xl font-bold text-sm transition-all ${activeTab === 'izin' ? 'bg-pink-50 text-pink-600 shadow-sm' : 'text-gray-400 hover:text-gray-600'}`}>üìù Izin</button>
                        <button onClick={() => setActiveTab('rank')} className={`flex-1 py-3 rounded-xl font-bold text-sm transition-all ${activeTab === 'rank' ? 'bg-yellow-50 text-yellow-600 shadow-sm' : 'text-gray-400 hover:text-gray-600'}`}>üèÜ Peringkat</button>
                    </div>

                    {activeTab === 'absen' && (
                        <div className="space-y-6 scale-in">
                            <div className={`rounded-[2rem] p-8 text-white shadow-2xl relative overflow-hidden transition-all duration-500 ${!todayRecord ? 'bg-slate-500' : todayRecord.approval === 'rejected' ? 'bg-red-500' : todayRecord.approval === 'approved' ? 'bg-teal-500' : 'bg-orange-500'}`}>
                                <div className="absolute top-0 right-0 p-6 opacity-10"><Icons.Clock className="w-24 h-24"/></div>
                                <div className="flex justify-between items-start relative z-10">
                                    <div>
                                        <p className="text-xs font-bold opacity-80 uppercase mb-1 tracking-widest">Status Hari Ini</p>
                                        <h3 className="text-3xl font-bold mb-4">{!todayRecord ? 'Belum Absen' : todayRecord.status}</h3>
                                    </div>
                                    {todayRecord?.approval === 'pending' && <span className="bg-white/20 backdrop-blur-md px-3 py-1 rounded-full text-xs font-bold border border-white/30">Menunggu Verifikasi</span>}
                                </div>
                                {todayRecord?.type === 'hadir' && (
                                    <div className="mt-2 flex gap-4 relative z-10">
                                        <div className="bg-black/10 px-4 py-2 rounded-xl backdrop-blur-sm">
                                            <p className="text-[10px] opacity-70 uppercase font-bold">Masuk</p>
                                            <p className="font-mono font-bold text-lg">{todayRecord.timeIn}</p>
                                        </div>
                                        <div className="bg-black/10 px-4 py-2 rounded-xl backdrop-blur-sm">
                                            <p className="text-[10px] opacity-70 uppercase font-bold">Pulang</p>
                                            <p className="font-mono font-bold text-lg">{todayRecord.timeOut}</p>
                                        </div>
                                    </div>
                                )}
                            </div>

                            <div className="grid grid-cols-2 gap-5">
                                <button onClick={() => handleAbsenClick('masuk')} disabled={!!todayRecord} className={`group p-6 rounded-[2rem] flex flex-col items-center gap-4 shadow-xl border-b-4 transition-all active:translate-y-1 active:border-b-0 active:shadow-none ${!!todayRecord ? 'bg-gray-100 text-gray-300 border-gray-200 cursor-not-allowed' : 'bg-white text-indigo-600 border-indigo-100 hover:-translate-y-1 hover:shadow-indigo-100'}`}>
                                    <div className={`w-14 h-14 rounded-2xl flex items-center justify-center text-2xl transition-all ${!!todayRecord ? 'bg-gray-200' : 'bg-indigo-50 group-hover:bg-indigo-600 group-hover:text-white'}`}>‚òÄÔ∏è</div>
                                    <span className="font-bold">Masuk</span>
                                </button>
                                <button onClick={() => handleAbsenClick('pulang')} disabled={!hasClockedIn || hasClockedOut} className={`group p-6 rounded-[2rem] flex flex-col items-center gap-4 shadow-xl border-b-4 transition-all active:translate-y-1 active:border-b-0 active:shadow-none ${!hasClockedIn || hasClockedOut ? 'bg-gray-100 text-gray-300 border-gray-200 cursor-not-allowed' : 'bg-white text-pink-600 border-pink-100 hover:-translate-y-1 hover:shadow-pink-100'}`}>
                                    <div className={`w-14 h-14 rounded-2xl flex items-center justify-center text-2xl transition-all ${!hasClockedIn || hasClockedOut ? 'bg-gray-200' : 'bg-pink-50 group-hover:bg-pink-600 group-hover:text-white'}`}>üåô</div>
                                    <span className="font-bold">Pulang</span>
                                </button>
                            </div>
                        </div>
                    )}

                    {activeTab === 'izin' && (
                        <div className="bg-white rounded-[2rem] p-8 shadow-xl scale-in border border-gray-100">
                            <h3 className="font-bold text-xl text-gray-800 mb-6 flex items-center gap-2"><Icons.File className="w-5 h-5 text-pink-500"/> Form Pengajuan</h3>
                            <form onSubmit={handleSubmitLeave} className="space-y-5">
                                <div className="flex gap-2 p-1 bg-gray-50 rounded-xl">
                                    {['sakit', 'izin', 'dispen'].map(t => (
                                        <div key={t} onClick={() => setLeaveType(t)} className={`flex-1 py-2.5 text-center rounded-lg text-sm font-bold capitalize cursor-pointer transition-all ${leaveType === t ? 'bg-white text-pink-600 shadow-sm ring-1 ring-pink-100' : 'text-gray-400 hover:text-gray-600'}`}>{t}</div>
                                    ))}
                                </div>
                                <div className="border-2 border-dashed border-gray-200 rounded-2xl p-8 text-center relative hover:bg-gray-50 transition group cursor-pointer">
                                    <div className="w-12 h-12 bg-gray-100 rounded-full flex items-center justify-center mx-auto mb-3 text-gray-400 group-hover:bg-pink-50 group-hover:text-pink-500 transition"><Icons.Upload className="w-6 h-6"/></div>
                                    <p className="text-xs font-bold text-gray-500">{file ? file.name : "Upload Surat (PDF/Foto)"}</p>
                                    <input type="file" onChange={e => setFile(e.target.files[0])} className="absolute inset-0 opacity-0 cursor-pointer" accept="image/*,.pdf" />
                                </div>
                                <textarea placeholder="Tulis keterangan detail..." value={note} onChange={e => setNote(e.target.value)} className="w-full bg-gray-50 rounded-2xl p-4 text-sm focus:ring-2 focus:ring-indigo-100 focus:outline-none font-medium resize-none text-gray-700" rows="3"></textarea>
                                <button type="submit" disabled={!!todayRecord} className="w-full bg-gray-900 text-white py-4 rounded-2xl font-bold shadow-xl hover:bg-indigo-600 transition hover:-translate-y-1 disabled:bg-gray-200 disabled:cursor-not-allowed disabled:shadow-none disabled:transform-none">Kirim Pengajuan üì§</button>
                            </form>
                        </div>
                    )}

                    {activeTab === 'rank' && (
                        <div className="space-y-5 scale-in">
                            <div className="bg-gradient-to-br from-amber-300 to-orange-500 rounded-[2rem] p-6 text-white text-center shadow-lg relative overflow-hidden">
                                <div className="absolute top-0 left-0 w-full h-full bg-[url('data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjAiIGhlaWdodD0iMjAiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+PGNpcmNsZSBjeD0iMSIgY3k9IjEiIHI9IjEiIGZpbGw9InJnYmEoMjU1LDI1NSwyNTUsMC4yKSIvPjwvc3ZnPg==')] opacity-30"></div>
                                <h3 className="text-2xl font-bold relative z-10">Leaderboard</h3>
                                <p className="text-amber-100 text-sm relative z-10 font-medium">Siapa yang paling rajin bulan ini?</p>
                            </div>
                            <div className="bg-white rounded-[2rem] p-2 shadow-xl border border-gray-100">
                                {rankings.map((s, index) => (
                                    <div key={s.id} className={`flex items-center justify-between p-4 mb-1 rounded-2xl transition ${s.id === user.id ? 'bg-amber-50 border border-amber-100' : 'hover:bg-gray-50'}`}>
                                        <div className="flex items-center gap-4">
                                            <div className={`w-10 h-10 flex items-center justify-center rounded-full font-bold text-sm shadow-sm border-2 border-white ${index===0?'bg-gradient-to-br from-yellow-300 to-yellow-500 text-white':index===1?'bg-gradient-to-br from-gray-300 to-gray-400 text-white':index===2?'bg-gradient-to-br from-orange-300 to-orange-400 text-white':'bg-gray-100 text-gray-500'}`}>
                                                {index + 1}
                                            </div>
                                            <div>
                                                <p className={`font-bold ${s.id===user.id?'text-amber-700':'text-gray-700'}`}>{s.name}</p>
                                                <p className="text-[10px] font-bold text-gray-400 uppercase">{s.class}</p>
                                            </div>
                                        </div>
                                        <div className="text-center">
                                            <span className="font-bold text-xl text-indigo-600">{s.count}</span>
                                            <p className="text-[10px] text-gray-400 font-bold">Hadir</p>
                                        </div>
                                    </div>
                                ))}
                            </div>
                        </div>
                    )}
                    {camMode && <CameraCapture title={camMode === 'masuk' ? "Selfie Masuk" : "Selfie Pulang"} onClose={() => setCamMode(null)} onCapture={handleCapture}/>}
                </div>
            );
        };

        // 4. ADMIN DASHBOARD
        const AdminDashboard = ({ users, setUsers, attendance, messages, setMessages, showToast, isActive, supabase }) => {
            const [view, setView] = useState('dashboard'); 
            const [userTab, setUserTab] = useState('siswa'); 
            const [isModalOpen, setIsModalOpen] = useState(false);
            const [formData, setFormData] = useState({ username: '', password: '', name: '', class: '' });
            const [editingId, setEditingId] = useState(null);
            const [reportFilter, setReportFilter] = useState('daily'); 
            const [filterDate, setFilterDate] = useState(getTodayDate());
            const [visiblePasswords, setVisiblePasswords] = useState({});
            const [msgForm, setMsgForm] = useState({ teacherId: '', studentId: '', text: '' });
            const [confirmData, setConfirmData] = useState({ open: false, title: '', msg: '', action: null });

            const filteredUsers = users.filter(u => u.role === userTab);

            const togglePassword = (id) => {
                setVisiblePasswords(prev => ({ ...prev, [id]: !prev[id] }));
            };

            const handleUserSubmit = async (e) => {
                e.preventDefault();
                try {
                    let newUserList;
                    if (isActive && supabase) {
                        if (editingId) {
                            const updatedData = { ...formData, role: userTab };
                            const { data, error } = await supabase.from('users').update(updatedData).eq('id', editingId).select();
                            if (error) throw error;
                            newUserList = users.map(u => u.id === editingId ? data[0] : u);
                            showToast("Data diperbarui (Online)", "success");
                        } else {
                            const newData = { ...formData, id: Date.now(), role: userTab };
                            const { data, error } = await supabase.from('users').insert([newData]).select();
                            if (error) {
                                console.error("Supabase Error:", error);
                                throw error;
                            }
                            newUserList = [...users, data[0]];
                            showToast("User ditambahkan (Online)", "success");
                        }
                    } else {
                        // Local Storage Fallback
                        if (editingId) {
                            newUserList = users.map(u => u.id === editingId ? { ...u, ...formData, role: userTab } : u);
                            showToast("Data diperbarui (Demo Mode)", "success");
                        } else {
                            newUserList = [...users, { ...formData, id: Date.now(), role: userTab }];
                            showToast("User ditambahkan (Demo Mode)", "success");
                        }
                    }
                    setUsers(newUserList); 
                    closeModal();
                } catch (err) {
                    const errorMsg = err.message || "Gagal simpan.";
                    if (errorMsg.includes("row-level security")) {
                        showToast("Gagal: RLS Supabase Aktif. Matikan dulu.", "error");
                    } else {
                        showToast(`Error: ${errorMsg}`, "error");
                    }
                }
            };
            const openModal = (user = null) => { setFormData(user ? { ...user } : { username: '', password: '', name: '', class: '' }); setEditingId(user ? user.id : null); setIsModalOpen(true); };
            const closeModal = () => setIsModalOpen(false);
            
            const handleDeleteClick = (id) => {
                setConfirmData({
                    open: true,
                    title: "Hapus User?",
                    msg: "Data user ini akan dihapus permanen. Lanjutkan?",
                    action: async () => {
                        try {
                            if (isActive && supabase) {
                                const { error } = await supabase.from('users').delete().eq('id', id);
                                if (error) throw error;
                                showToast("User dihapus (Online)", "success");
                            } else {
                                showToast("User dihapus (Demo Mode)", "success");
                            }
                            setUsers(users.filter(u => u.id !== id));
                        } catch(err) {
                            showToast("Gagal menghapus user", "error");
                        }
                        setConfirmData({ ...confirmData, open: false });
                    }
                });
            };

            const handleSendMessage = async (e) => {
                e.preventDefault();
                const newMessage = {
                    id: Date.now(),
                    date: getTodayDate(),
                    sender: 'Admin',
                    recipientId: parseInt(msgForm.teacherId),
                    studentId: parseInt(msgForm.studentId),
                    content: msgForm.text
                };
                
                try {
                    if (isActive && supabase) {
                        const { data, error } = await supabase.from('messages').insert([newMessage]).select();
                        if (error) throw error;
                        setMessages([...messages, data[0]]);
                        showToast("Pesan terkirim (Online) üì®", "success");
                    } else {
                        setMessages([...messages, newMessage]);
                        showToast("Pesan terkirim (Demo Mode) üì®", "success");
                    }
                    setMsgForm({ teacherId: '', studentId: '', text: '' });
                } catch(err) {
                    const errorMsg = err.message || "Gagal kirim.";
                    if (errorMsg.includes("row-level security")) {
                        showToast("Gagal: RLS Supabase Aktif.", "error");
                    } else {
                        showToast(`Error: ${errorMsg}`, "error");
                    }
                }
            };

            const todayStats = useMemo(() => {
                const today = getTodayDate();
                const todaysData = attendance.filter(a => a.date === today);
                const hadirList = todaysData.filter(a => a.type === 'hadir').map(a => users.find(u => u.id === a.studentId)?.name);
                return { totalStudents: users.filter(u => u.role === 'siswa').length, hadir: hadirList, totalHadir: hadirList.length, totalSakit: todaysData.filter(a => a.type === 'sakit').length, totalIzin: todaysData.filter(a => ['izin', 'dispen'].includes(a.type)).length };
            }, [attendance, users]);

            const reportData = useMemo(() => {
                const students = users.filter(u => u.role === 'siswa');
                return students.map(student => {
                    // Fix: Pastikan perbandingan ID aman (String vs Number)
                    let filteredAttendance = attendance.filter(a => String(a.studentId) === String(student.id));
                    
                    if (reportFilter === 'daily') { 
                        filteredAttendance = filteredAttendance.filter(a => a.date === filterDate); 
                    } else if (reportFilter === 'monthly') { 
                        // Fix: Filter bulan (YYYY-MM)
                        const monthStr = filterDate.slice(0, 7);
                        filteredAttendance = filteredAttendance.filter(a => a.date && a.date.startsWith(monthStr)); 
                    }
                    else if (reportFilter === 'weekly') {
                        const selected = new Date(filterDate);
                        const oneWeekAgo = new Date(selected);
                        oneWeekAgo.setDate(selected.getDate() - 7);
                        filteredAttendance = filteredAttendance.filter(a => {
                            const d = new Date(a.date);
                            return d >= oneWeekAgo && d <= selected;
                        });
                    }
                    
                    // Ambil status harian (jika ada)
                    const statusHarian = filteredAttendance.length > 0 ? filteredAttendance[0].status : '-';
                    
                    return { 
                        ...student, 
                        statusHarian, 
                        hadir: filteredAttendance.filter(a => a.type === 'hadir').length, 
                        sakit: filteredAttendance.filter(a => a.type === 'sakit').length, 
                        izin: filteredAttendance.filter(a => ['izin', 'dispen'].includes(a.type)).length 
                    };
                });
            }, [users, attendance, reportFilter, filterDate]);

            const handleDownloadReport = () => {
                const headers = reportFilter === 'daily' 
                    ? ['Nama Siswa', 'Kelas', 'Status Kehadiran', 'Tanggal'] 
                    : ['Nama Siswa', 'Kelas', 'Total Hadir', 'Total Sakit', 'Total Izin/Dispen', 'Periode'];
                const rows = [headers];
                reportData.forEach(r => {
                    if (reportFilter === 'daily') {
                        rows.push([r.name, r.class, r.statusHarian, filterDate]);
                    } else {
                        rows.push([r.name, r.class, r.hadir, r.sakit, r.izin, filterDate]);
                    }
                });
                exportToCSV(`Laporan_Admin_${reportFilter}_${filterDate}.csv`, rows);
                showToast("Laporan berhasil diunduh", "success");
            };

            return (
                <div className="max-w-6xl mx-auto p-6 fade-in">
                    <ConfirmModal isOpen={confirmData.open} title={confirmData.title} message={confirmData.msg} onConfirm={confirmData.action} onCancel={() => setConfirmData({...confirmData, open: false})} />
                    
                    <div className="flex flex-col md:flex-row justify-between items-center mb-8 bg-white p-8 rounded-[2rem] shadow-sm border border-gray-100">
                        <div>
                            <h1 className="text-3xl font-bold text-gray-800">Dashboard Admin</h1>
                            <p className="text-gray-500 mt-1">Kelola sekolah dengan mudah üè´</p>
                        </div>
                        <div className="flex gap-3 mt-4 md:mt-0 flex-wrap justify-center">
                            {['dashboard', 'users', 'report', 'message'].map(v => (
                                <button key={v} onClick={() => setView(v)} className={`px-6 py-3 rounded-xl text-sm font-bold capitalize transition-all ${view === v ? 'bg-gray-900 text-white shadow-lg transform scale-105' : 'bg-gray-100 text-gray-500 hover:bg-gray-200'}`}>
                                    {v === 'message' ? 'Kirim Pesan' : v === 'users' ? 'Manajemen' : v === 'report' ? 'Laporan' : 'Ringkasan'}
                                </button>
                            ))}
                        </div>
                    </div>

                    {view === 'dashboard' && (
                        <div className="space-y-6 scale-in">
                            <div className="grid grid-cols-1 md:grid-cols-4 gap-6">
                                <div className="bg-white p-8 rounded-[2rem] shadow-lg shadow-indigo-50 border border-indigo-100 hover:-translate-y-2 transition duration-300">
                                    <p className="text-gray-400 text-xs font-bold uppercase tracking-wider">Total Siswa</p>
                                    <p className="text-4xl font-bold text-indigo-600 mt-2">{todayStats.totalStudents}</p>
                                </div>
                                <div className="bg-white p-8 rounded-[2rem] shadow-lg shadow-teal-50 border border-teal-100 hover:-translate-y-2 transition duration-300">
                                    <p className="text-gray-400 text-xs font-bold uppercase tracking-wider">Hadir Hari Ini</p>
                                    <p className="text-4xl font-bold text-teal-600 mt-2">{todayStats.totalHadir}</p>
                                </div>
                                <div className="bg-white p-8 rounded-[2rem] shadow-lg shadow-orange-50 border border-orange-100 hover:-translate-y-2 transition duration-300">
                                    <p className="text-gray-400 text-xs font-bold uppercase tracking-wider">Sakit</p>
                                    <p className="text-4xl font-bold text-orange-500 mt-2">{todayStats.totalSakit}</p>
                                </div>
                                <div className="bg-white p-8 rounded-[2rem] shadow-lg shadow-pink-50 border border-pink-100 hover:-translate-y-2 transition duration-300">
                                    <p className="text-gray-400 text-xs font-bold uppercase tracking-wider">Izin/Dispen</p>
                                    <p className="text-4xl font-bold text-pink-500 mt-2">{todayStats.totalIzin}</p>
                                </div>
                            </div>
                        </div>
                    )}

                    {view === 'message' && (
                        <div className="bg-white rounded-[2rem] shadow-xl p-10 max-w-2xl mx-auto scale-in border border-gray-100">
                            <h2 className="text-2xl font-bold text-gray-800 mb-8 flex items-center gap-3"><Icons.Message className="w-8 h-8 text-indigo-600"/> Kirim Pesan ke Guru</h2>
                            <form onSubmit={handleSendMessage} className="space-y-6">
                                <div><label className="block text-sm font-bold text-gray-400 uppercase mb-2 ml-1">Pilih Guru Wali Kelas</label><select required className="w-full p-4 bg-gray-50 rounded-2xl border-none focus:ring-2 focus:ring-indigo-100 outline-none font-medium text-gray-700" value={msgForm.teacherId} onChange={e => setMsgForm({...msgForm, teacherId: e.target.value})}><option value="">-- Pilih Guru --</option>{users.filter(u => u.role === 'guru').map(g => <option key={g.id} value={g.id}>{g.name}</option>)}</select></div>
                                <div><label className="block text-sm font-bold text-gray-400 uppercase mb-2 ml-1">Siswa Terkait (Perwalian)</label><select required className="w-full p-4 bg-gray-50 rounded-2xl border-none focus:ring-2 focus:ring-indigo-100 outline-none font-medium text-gray-700" value={msgForm.studentId} onChange={e => setMsgForm({...msgForm, studentId: e.target.value})}><option value="">-- Pilih Siswa --</option>{users.filter(u => u.role === 'siswa').map(s => <option key={s.id} value={s.id}>{s.name} - {s.class}</option>)}</select></div>
                                <div><label className="block text-sm font-bold text-gray-400 uppercase mb-2 ml-1">Isi Pesan</label><textarea required rows="4" className="w-full p-4 bg-gray-50 rounded-2xl border-none focus:ring-2 focus:ring-indigo-100 outline-none font-medium text-gray-700 resize-none" placeholder="Tulis pesan mengenai siswa..." value={msgForm.text} onChange={e => setMsgForm({...msgForm, text: e.target.value})}></textarea></div>
                                <button type="submit" className="w-full bg-gray-900 text-white py-4 rounded-2xl font-bold hover:bg-indigo-600 transition shadow-xl flex items-center justify-center gap-2">Kirim Pesan <Icons.Send className="w-5 h-5"/></button>
                            </form>
                        </div>
                    )}

                    {view === 'users' && (
                        <div className="bg-white rounded-[2rem] shadow-xl overflow-hidden scale-in border border-gray-100">
                            <div className="p-6 border-b flex justify-between items-center bg-gray-50">
                                <div className="flex gap-2 p-1 bg-gray-200 rounded-xl">
                                    <button onClick={() => setUserTab('siswa')} className={`px-6 py-2.5 rounded-lg font-bold text-sm transition ${userTab === 'siswa' ? 'bg-white text-indigo-600 shadow' : 'bg-transparent text-gray-500'}`}>Data Siswa</button>
                                    <button onClick={() => setUserTab('guru')} className={`px-6 py-2.5 rounded-lg font-bold text-sm transition ${userTab === 'guru' ? 'bg-white text-indigo-600 shadow' : 'bg-transparent text-gray-500'}`}>Data Guru</button>
                                </div>
                                <button onClick={() => openModal()} className="bg-emerald-500 hover:bg-emerald-600 text-white px-5 py-2.5 rounded-xl font-bold text-sm flex items-center gap-2 shadow-lg transition transform hover:-translate-y-0.5"><Icons.User className="w-4 h-4"/> Tambah Baru</button>
                            </div>
                            <div className="p-0"><table className="w-full text-left border-collapse"><thead className="bg-gray-50 text-gray-400 text-xs uppercase font-bold border-b"><tr><th className="p-4 pl-6">Nama</th><th className="p-4">Username</th><th className="p-4">Password</th>{(userTab === 'siswa' || userTab === 'guru') && <th className="p-4">{userTab === 'siswa' ? 'Kelas' : 'Wali Kelas'}</th>}<th className="p-4 text-right pr-6">Aksi</th></tr></thead>
                            <tbody className="text-sm text-gray-600 divide-y divide-gray-100">{filteredUsers.map(u => (
                                <tr key={u.id} className="hover:bg-indigo-50/30 transition">
                                    <td className="p-4 pl-6 font-bold text-gray-800">{u.name}</td>
                                    <td className="p-4">{u.username}</td>
                                    <td className="p-4 font-mono flex items-center gap-2">
                                        <span className="text-gray-400">{visiblePasswords[u.id] ? u.password : '‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢'}</span>
                                        <button onClick={() => togglePassword(u.id)} className="text-gray-300 hover:text-indigo-500 transition"><Icons.Eye className="w-4 h-4"/></button>
                                    </td>
                                    {(userTab === 'siswa' || userTab === 'guru') && (
                                        <td className="p-4">
                                            <span className="bg-gray-100 text-gray-600 px-2.5 py-1 rounded-lg text-xs font-bold border border-gray-200">
                                                {u.class || '-'}
                                            </span>
                                        </td>
                                    )}
                                    <td className="p-4 text-right pr-6"><div className="flex justify-end gap-2"><button onClick={() => openModal(u)} className="text-blue-500 hover:bg-blue-50 p-2 rounded-xl transition"><Icons.Edit className="w-4 h-4"/></button><button onClick={() => handleDeleteClick(u.id)} className="text-red-500 hover:bg-red-50 p-2 rounded-xl transition"><Icons.Trash className="w-4 h-4"/></button></div></td>
                                </tr>))}
                            </tbody></table></div>
                        </div>
                    )}

                    {view === 'report' && (
                        <div className="bg-white rounded-[2rem] shadow-xl overflow-hidden p-8 scale-in border border-gray-100">
                            <div className="flex flex-col md:flex-row justify-between items-center mb-8 gap-4">
                                <h3 className="font-bold text-xl text-gray-800">Laporan Kehadiran</h3>
                                <div className="flex items-center gap-3 bg-gray-50 p-2 rounded-2xl border border-gray-100">
                                    <button onClick={handleDownloadReport} className="bg-emerald-500 hover:bg-emerald-600 text-white px-5 py-2.5 rounded-xl text-sm font-bold flex items-center gap-2 shadow-lg shadow-emerald-100 transition"><Icons.Download className="w-4 h-4"/> Export CSV</button>
                                    <div className="h-6 w-px bg-gray-300 mx-1"></div>
                                    <select value={reportFilter} onChange={(e) => setReportFilter(e.target.value)} className="bg-transparent border-none text-sm font-bold text-gray-600 focus:ring-0 cursor-pointer outline-none"><option value="daily">Harian</option><option value="weekly">Mingguan</option><option value="monthly">Bulanan</option></select>
                                    <input type={reportFilter === 'monthly' ? 'month' : 'date'} value={filterDate} onChange={(e) => setFilterDate(e.target.value)} className="bg-transparent border-none text-sm font-bold text-gray-600 focus:ring-0 outline-none"/>
                                </div>
                            </div>
                            <div className="overflow-x-auto rounded-2xl border border-gray-100"><table className="w-full text-left border-collapse"><thead className="bg-indigo-50 text-indigo-900 text-xs uppercase font-bold"><tr><th className="p-4 pl-6">Siswa</th>{reportFilter === 'daily' ? (<th className="p-4 text-center">Status</th>) : (<><th className="p-4 text-center">Hadir</th><th className="p-4 text-center">Sakit</th><th className="p-4 text-center pr-6">Izin/Dispen</th></>)}</tr></thead><tbody className="text-sm text-gray-600 divide-y divide-gray-100">{reportData.map(r => (<tr key={r.id} className="hover:bg-gray-50"><td className="p-4 pl-6"><div className="font-bold text-gray-800">{r.name}</div><div className="text-xs text-indigo-400 font-bold mt-0.5">{r.class}</div></td>{reportFilter === 'daily' ? (<td className="p-4 text-center"><span className={`px-3 py-1 rounded-full text-xs font-bold ${r.statusHarian === 'Hadir' ? 'bg-teal-100 text-teal-700' : r.statusHarian === 'Sakit' ? 'bg-orange-100 text-orange-700' : r.statusHarian === '-' ? 'bg-gray-100 text-gray-400' : 'bg-pink-100 text-pink-700'}`}>{r.statusHarian === '-' ? 'Belum Absen' : r.statusHarian}</span></td>) : (<><td className="p-4 text-center font-bold text-teal-600">{r.hadir}</td><td className="p-4 text-center font-bold text-orange-500">{r.sakit}</td><td className="p-4 text-center font-bold text-pink-500 pr-6">{r.izin}</td></>)}</tr>))}</tbody></table></div>
                        </div>
                    )}

                    {isModalOpen && (
                        <div className="fixed inset-0 bg-black/70 flex items-center justify-center z-[80] p-4 backdrop-blur-sm">
                            <div className="bg-white rounded-[2rem] p-8 w-full max-w-md shadow-2xl scale-in">
                                <h3 className="text-2xl font-bold mb-6 text-gray-800">{editingId ? 'Edit' : 'Tambah'} {userTab === 'guru' ? 'Guru' : 'Siswa'}</h3>
                                <form onSubmit={handleUserSubmit} className="space-y-4">
                                    <div className="space-y-1"><label className="text-xs font-bold text-gray-400 uppercase ml-2">Nama Lengkap</label><input required className="w-full p-4 bg-gray-50 rounded-2xl border-none font-medium focus:ring-2 focus:ring-indigo-100 outline-none" value={formData.name} onChange={e => setFormData({...formData, name: e.target.value})}/></div>
                                    <div className="space-y-1"><label className="text-xs font-bold text-gray-400 uppercase ml-2">Username</label><input required className="w-full p-4 bg-gray-50 rounded-2xl border-none font-medium focus:ring-2 focus:ring-indigo-100 outline-none" value={formData.username} onChange={e => setFormData({...formData, username: e.target.value})}/></div>
                                    <div className="space-y-1"><label className="text-xs font-bold text-gray-400 uppercase ml-2">Password</label><input required className="w-full p-4 bg-gray-50 rounded-2xl border-none font-medium focus:ring-2 focus:ring-indigo-100 outline-none" value={formData.password} onChange={e => setFormData({...formData, password: e.target.value})}/></div>
                                    {(userTab === 'siswa' || userTab === 'guru') && (
                                        <div className="space-y-1">
                                            <label className="text-xs font-bold text-gray-400 uppercase ml-2">{userTab === 'siswa' ? "Kelas" : "Perwalian"}</label>
                                            <input required placeholder="Misal: XII RPL 1" className="w-full p-4 bg-gray-50 rounded-2xl border-none font-medium focus:ring-2 focus:ring-indigo-100 outline-none" value={formData.class || ''} onChange={e => setFormData({...formData, class: e.target.value})}/>
                                        </div>
                                    )}
                                    <div className="flex justify-end gap-3 mt-8"><button type="button" onClick={closeModal} className="px-6 py-3 text-gray-500 font-bold hover:bg-gray-100 rounded-xl transition">Batal</button><button type="submit" className="px-6 py-3 bg-gray-900 text-white font-bold rounded-xl shadow-lg hover:bg-indigo-600 transition">Simpan Data</button></div>
                                </form>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        // 5. GURU DASHBOARD
        const GuruDashboard = ({ users, user, attendance, setAttendance, messages, showToast, isActive, supabase }) => {
            const [activeTab, setActiveTab] = useState('harian'); 
            const [validationType, setValidationType] = useState('hadir'); 
            const [date, setDate] = useState(getTodayDate());
            const [month, setMonth] = useState(getTodayDate().slice(0, 7));
            const [viewImg, setViewImg] = useState(null);
            const [confirmData, setConfirmData] = useState({ open: false, title: '', msg: '', action: null });
            
            const myStudents = users.filter(u => u.role === 'siswa' && u.class === user.class);
            const myStudentIds = myStudents.map(s => s.id);

            const dailyData = attendance.filter(a => a.date === date && myStudentIds.includes(a.studentId)).map(a => { 
                const s = users.find(u => u.id === a.studentId); 
                return { ...a, name: s?.name, class: s?.class }; 
            }).filter(r => {
                if (validationType === 'hadir') {
                    return r.type === 'hadir';
                } else {
                    return ['sakit', 'izin', 'dispen'].includes(r.type); 
                }
            });
            
            const monthlyStats = useMemo(() => {
                return myStudents.map(s => {
                    const recs = attendance.filter(a => a.studentId === s.id && a.date.startsWith(month));
                    return { ...s, hadir: recs.filter(a => a.type === 'hadir' && a.approval === 'approved').length, sakit: recs.filter(a => a.type === 'sakit' && a.approval === 'approved').length, izin: recs.filter(a => ['izin', 'dispen'].includes(a.type) && a.approval === 'approved').length };
                });
            }, [users, attendance, month, myStudents]);

            const myMessages = messages.filter(m => m.recipientId === user.id).sort((a, b) => b.id - a.id);

            const handleAction = (id, status) => { 
                setConfirmData({
                    open: true,
                    title: status === 'approved' ? "Terima Absensi?" : "Tolak Absensi?",
                    msg: `Anda akan ${status === 'approved' ? 'menerima' : 'menolak'} data ini. Lanjutkan?`,
                    action: async () => {
                        try {
                            if (isActive && supabase) {
                                const { error } = await supabase.from('attendance').update({ approval: status }).eq('id', id);
                                if (error) throw error;
                                showToast(`Status diperbarui (Online)`, status === 'approved' ? 'success' : 'error');
                            } else {
                                showToast(`Status diperbarui (Demo Mode)`, status === 'approved' ? 'success' : 'error');
                            }
                            const updated = attendance.map(item => item.id === id ? { ...item, approval: status } : item);
                            setAttendance(updated);
                        } catch (err) {
                            showToast("Gagal memperbarui status", "error");
                        }
                        setConfirmData({ ...confirmData, open: false });
                    }
                });
            };
            
            const openImage = (url) => setViewImg(url);

            const handleExportGuru = () => {
                const headers = ['Nama Siswa', 'Kelas', 'Hadir (Disetujui)', 'Sakit', 'Izin/Dispen', 'Bulan'];
                const rows = [headers];
                monthlyStats.forEach(s => {
                    rows.push([s.name, s.class, s.hadir, s.sakit, s.izin, month]);
                });
                exportToCSV(`Laporan_Guru_${month}.csv`, rows);
                showToast("Laporan diunduh", "success");
            };

            return (
                <div className="max-w-6xl mx-auto p-6 fade-in">
                     <ConfirmModal isOpen={confirmData.open} title={confirmData.title} message={confirmData.msg} onConfirm={confirmData.action} onCancel={() => setConfirmData({...confirmData, open: false})} />

                    <div className="flex flex-col md:flex-row justify-between items-center mb-8 bg-white p-8 rounded-[2rem] shadow-sm border border-gray-100">
                        <div>
                            <h1 className="text-2xl font-bold text-gray-800 flex items-center gap-3"><span className="text-4xl">üë©‚Äçüè´</span> Dashboard Guru</h1>
                            <p className="text-gray-500 text-sm mt-2 font-bold bg-gray-100 px-3 py-1 rounded-lg inline-block">Kelas Perwalian: {user.class}</p>
                        </div>
                        <div className="flex gap-2 mt-4 md:mt-0 bg-gray-100 p-1.5 rounded-2xl overflow-x-auto">
                            {['harian', 'rekap', 'siswa', 'pesan'].map(t => (
                                <button key={t} onClick={() => setActiveTab(t)} className={`px-5 py-2.5 rounded-xl text-sm font-bold capitalize whitespace-nowrap transition-all duration-300 ${activeTab === t ? 'bg-white text-indigo-600 shadow-md' : 'text-gray-500 hover:text-indigo-500'}`}>
                                    {t === 'harian' ? 'Validasi' : t === 'rekap' ? 'Laporan' : t === 'siswa' ? 'Siswa' : 'Kotak Masuk'}
                                </button>
                            ))}
                        </div>
                    </div>

                    {activeTab === 'harian' && (
                        <div className="bg-white rounded-[2rem] shadow-xl overflow-hidden scale-in border border-gray-100">
                            <div className="p-6 border-b flex flex-col md:flex-row justify-between items-center gap-4 bg-gray-50/50">
                                <div className="flex gap-2 bg-gray-100 p-1 rounded-xl">
                                    <button onClick={() => setValidationType('hadir')} className={`px-4 py-2 rounded-lg text-sm font-bold transition ${validationType === 'hadir' ? 'bg-indigo-600 text-white shadow' : 'text-gray-500'}`}>Absensi Hadir</button>
                                    <button onClick={() => setValidationType('izin')} className={`px-4 py-2 rounded-lg text-sm font-bold transition ${validationType === 'izin' ? 'bg-pink-600 text-white shadow' : 'text-gray-500'}`}>Pengajuan Izin</button>
                                </div>
                                <input type="date" value={date} onChange={e => setDate(e.target.value)} className="p-2.5 rounded-xl border-none bg-gray-100 font-bold text-gray-600 focus:ring-2 focus:ring-indigo-100 outline-none"/>
                            </div>
                            
                            <div className="overflow-x-auto">
                                <table className="w-full text-left border-collapse">
                                    <thead className="bg-indigo-50 text-indigo-900 text-xs uppercase font-bold">
                                        <tr>
                                            <th className="p-4 pl-6">Siswa</th>
                                            {validationType === 'hadir' ? (
                                                <>
                                                    <th className="p-4">Jam Masuk</th>
                                                    <th className="p-4">Jam Pulang</th>
                                                    <th className="p-4 text-center">Foto Masuk</th>
                                                    <th className="p-4 text-center">Foto Pulang</th>
                                                </>
                                            ) : (
                                                <>
                                                    <th className="p-4">Tipe Izin</th>
                                                    <th className="p-4">Keterangan</th>
                                                    <th className="p-4 text-center">Bukti Surat</th>
                                                </>
                                            )}
                                            <th className="p-4 text-right pr-6">Aksi / Status</th>
                                        </tr>
                                    </thead>
                                    <tbody className="text-sm text-gray-600 divide-y divide-gray-100">
                                        {dailyData.length === 0 ? <tr><td colSpan="6" className="p-12 text-center italic text-gray-400">Tidak ada data untuk kategori ini</td></tr> : 
                                        dailyData.map(r => (
                                            <tr key={r.id} className="hover:bg-indigo-50/30 transition">
                                                <td className="p-4 pl-6">
                                                    <div className="font-bold text-gray-800">{r.name}</div>
                                                    <div className="text-xs text-indigo-500 font-bold">{r.class}</div>
                                                </td>
                                                
                                                {validationType === 'hadir' ? (
                                                    <>
                                                        <td className="p-4 font-mono text-xs font-bold">{r.timeIn}</td>
                                                        <td className="p-4 font-mono text-xs font-bold text-gray-400">{r.timeOut}</td>
                                                        <td className="p-4 text-center">
                                                            {r.proof ? <img src={r.proof} className="w-12 h-12 rounded-full object-cover border-2 border-white shadow-md mx-auto cursor-pointer hover:scale-110 transition" onClick={() => openImage(r.proof)}/> : '-'}
                                                        </td>
                                                        <td className="p-4 text-center">
                                                            {r.proofOut ? <img src={r.proofOut} className="w-12 h-12 rounded-full object-cover border-2 border-white shadow-md mx-auto cursor-pointer hover:scale-110 transition" onClick={() => openImage(r.proofOut)}/> : '-'}
                                                        </td>
                                                    </>
                                                ) : (
                                                    <>
                                                        <td className="p-4"><span className="bg-pink-50 text-pink-600 px-3 py-1 rounded-full text-xs font-bold capitalize border border-pink-100">{r.type}</span></td>
                                                        <td className="p-4 text-xs italic max-w-xs truncate text-gray-500">{r.note || '-'}</td>
                                                        <td className="p-4 text-center">
                                                            {r.proof && <button onClick={() => openImage(r.proof)} className="text-xs bg-indigo-50 text-indigo-600 px-3 py-1.5 rounded-lg font-bold hover:bg-indigo-100 transition flex items-center justify-center mx-auto gap-1"><Icons.File className="w-3 h-3"/> Lihat File</button>}
                                                        </td>
                                                    </>
                                                )}

                                                <td className="p-4 text-right pr-6">
                                                    {r.approval === 'pending' ? (
                                                        <div className="flex justify-end gap-2">
                                                            <button onClick={() => handleAction(r.id, 'approved')} className="bg-emerald-500 text-white p-2 rounded-xl hover:bg-emerald-600 transition shadow-md hover:shadow-lg transform hover:-translate-y-0.5" title="Terima"><Icons.Check className="w-4 h-4"/></button>
                                                            <button onClick={() => handleAction(r.id, 'rejected')} className="bg-red-500 text-white p-2 rounded-xl hover:bg-red-600 transition shadow-md hover:shadow-lg transform hover:-translate-y-0.5" title="Tolak"><Icons.X className="w-4 h-4"/></button>
                                                        </div>
                                                    ) : (
                                                        <span className={`text-xs font-bold px-3 py-1.5 rounded-full border ${r.approval === 'approved' ? 'bg-emerald-50 text-emerald-600 border-emerald-100' : 'bg-red-50 text-red-600 border-red-100'}`}>
                                                            {r.approval === 'approved' ? 'Diterima' : 'Ditolak'}
                                                        </span>
                                                    )}
                                                </td>
                                            </tr>
                                        ))}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    )}

                    {activeTab === 'rekap' && (
                        <div className="bg-white rounded-[2rem] shadow-xl overflow-hidden p-8 scale-in border border-gray-100">
                            <div className="flex justify-between items-center mb-8">
                                <h3 className="font-bold text-gray-800 text-xl">Laporan Bulanan</h3>
                                <div className="flex gap-3">
                                    <button onClick={handleExportGuru} className="bg-emerald-500 hover:bg-emerald-600 text-white px-5 py-2.5 rounded-xl text-sm font-bold flex items-center gap-2 shadow-lg shadow-emerald-100 transition"><Icons.Download className="w-4 h-4"/> Export CSV</button>
                                    <input type="month" value={month} onChange={e => setMonth(e.target.value)} className="p-2.5 rounded-xl border-none bg-gray-100 font-bold text-gray-600 focus:ring-2 focus:ring-indigo-100 outline-none"/>
                                </div>
                            </div>
                            <div className="overflow-x-auto rounded-2xl border border-gray-100"><table className="w-full text-left border-collapse"><thead className="bg-gray-50 text-gray-400 text-xs uppercase font-bold"><tr><th className="p-4 pl-6">Siswa</th><th className="p-4 text-center">Hadir</th><th className="p-4 text-center">Sakit</th><th className="p-4 text-center pr-6">Izin</th></tr></thead><tbody className="text-sm text-gray-600 divide-y divide-gray-100">{monthlyStats.map(s => (<tr key={s.id} className="hover:bg-gray-50"><td className="p-4 pl-6"><div className="font-bold text-gray-800">{s.name}</div><div className="text-xs text-indigo-400 font-bold mt-0.5">{s.class}</div></td><td className="p-4 text-center font-bold text-teal-600">{s.hadir}</td><td className="p-4 text-center font-bold text-orange-500">{s.sakit}</td><td className="p-4 text-center font-bold text-pink-500 pr-6">{s.izin}</td></tr>))}</tbody></table></div>
                        </div>
                    )}

                    {activeTab === 'pesan' && (
                        <div className="space-y-4 scale-in">
                            <h3 className="font-bold text-xl text-gray-800 mb-4">Kotak Masuk <span className="text-sm font-normal text-gray-500">(Pesan dari Admin)</span></h3>
                            {myMessages.length === 0 ? (
                                <div className="bg-white p-16 rounded-[2rem] text-center border border-gray-100 shadow-sm">
                                    <div className="text-6xl mb-4">üì≠</div>
                                    <p className="text-gray-400 font-medium">Belum ada pesan masuk</p>
                                </div>
                            ) : (
                                <div className="grid gap-4">
                                    {myMessages.map(msg => {
                                        const studentName = users.find(u => u.id === msg.studentId)?.name || 'Unknown';
                                        return (
                                            <div key={msg.id} className="bg-white p-6 rounded-3xl shadow-sm border border-gray-100 hover:shadow-md transition relative overflow-hidden group">
                                                <div className="absolute left-0 top-0 bottom-0 w-1.5 bg-indigo-500"></div>
                                                <div className="flex justify-between items-start mb-3 pl-2">
                                                    <span className="bg-indigo-50 text-indigo-600 px-3 py-1 rounded-lg text-xs font-bold uppercase tracking-wide">Perihal: {studentName}</span>
                                                    <span className="text-xs text-gray-400 font-mono">{msg.date}</span>
                                                </div>
                                                <p className="text-gray-700 font-medium text-lg pl-2 leading-relaxed">"{msg.content}"</p>
                                                <div className="mt-4 pt-4 border-t border-gray-50 pl-2">
                                                    <p className="text-xs text-gray-400 font-bold flex items-center gap-1"><Icons.User className="w-3 h-3"/> Admin Sekolah</p>
                                                </div>
                                            </div>
                                        );
                                    })}
                                </div>
                            )}
                        </div>
                    )}

                    {activeTab === 'siswa' && (
                         <div className="grid grid-cols-1 md:grid-cols-3 gap-5 scale-in">{myStudents.map(s=>(<div key={s.id} className="bg-white p-6 rounded-3xl shadow-sm border border-gray-100 flex items-center gap-5 hover:shadow-md transition"><div className="w-14 h-14 rounded-2xl bg-gradient-to-br from-indigo-100 to-indigo-50 flex items-center justify-center text-indigo-600 font-bold text-2xl shadow-inner">{s.name.charAt(0)}</div><div><h4 className="font-bold text-gray-800 text-lg">{s.name}</h4><p className="text-xs font-bold text-gray-400 uppercase tracking-wide">{s.class}</p></div></div>))}</div>
                    )}

                    {viewImg && (
                        <div className="fixed inset-0 bg-black/90 z-[100] flex items-center justify-center p-4 fade-in backdrop-blur-sm" onClick={() => setViewImg(null)}>
                            {viewImg.startsWith('data:application/pdf') ? (
                                <iframe src={viewImg} className="w-full max-w-4xl h-[85vh] bg-white rounded-2xl shadow-2xl"></iframe>
                            ) : (
                                <img src={viewImg} className="rounded-2xl max-h-[85vh] shadow-2xl border-4 border-white photo-result"/>
                            )}
                            <button className="absolute top-4 right-4 bg-white/20 text-white p-2 rounded-full hover:bg-white/40 transition"><Icons.X className="w-6 h-6"/></button>
                        </div>
                    )}
                </div>
            );
        };

        // 6. MAIN APP
        const App = () => {
            const [user, setUser] = useState(null);
            const [users, setUsers] = useState(() => JSON.parse(localStorage.getItem('smartattend_users')) || INITIAL_USERS);
            const [attendance, setAttendance] = useState(() => JSON.parse(localStorage.getItem('smartattend_data')) || []);
            const [messages, setMessages] = useState(() => JSON.parse(localStorage.getItem('smartattend_messages')) || []);
            const [toast, setToast] = useState(null);
            const [supabaseClient, setSupabaseClient] = useState(null);
            const [isOnline, setIsOnline] = useState(false);
            const [onlineStatusMsg, setOnlineStatusMsg] = useState('Memuat...');

            // Smart Loader for Supabase
            useEffect(() => {
                const checkSupabase = () => {
                    const sb = window.supabase || window.Supabase; // Cek kedua kemungkinan casing
                    if (typeof sb !== 'undefined' && sb) {
                        const clientFunc = sb.createClient || (sb.default && sb.default.createClient);
                        if (typeof clientFunc === 'function') {
                            try {
                                const client = clientFunc(supabaseUrl, supabaseKey);
                                setSupabaseClient(client);
                                setIsOnline(true);
                                setOnlineStatusMsg("Online");
                                console.log("‚úÖ Supabase Connected via SmartLoader");
                                return true;
                            } catch (err) {
                                console.error("Init failed:", err);
                            }
                        }
                    }
                    return false;
                };

                // Coba langsung
                if (!checkSupabase()) {
                    // Jika gagal, coba lagi setiap 1 detik (Max 10 detik)
                    let attempts = 0;
                    const interval = setInterval(() => {
                        attempts++;
                        if (checkSupabase() || attempts > 10) {
                            clearInterval(interval);
                            if (attempts > 10) setOnlineStatusMsg("Offline (Lib Gagal)");
                        }
                    }, 1000);
                    return () => clearInterval(interval);
                }
            }, []);

            // LocalStorage Sync (Demo Mode)
            useEffect(() => {
                if (!isOnline) {
                    localStorage.setItem('smartattend_users', JSON.stringify(users));
                    localStorage.setItem('smartattend_data', JSON.stringify(attendance));
                    localStorage.setItem('smartattend_messages', JSON.stringify(messages));
                }
            }, [users, attendance, messages, isOnline]);

            // Supabase Fetch (Online Mode)
            useEffect(() => {
                if (isOnline && supabaseClient) {
                    const fetchData = async () => {
                        try {
                            // Users
                            let { data: uData, error: uError } = await supabaseClient.from('users').select('*');
                            if (!uError && uData && uData.length > 0) setUsers(uData);
                            else if (!uError && (!uData || uData.length === 0)) {
                                await supabaseClient.from('users').insert(INITIAL_USERS);
                                setUsers(INITIAL_USERS);
                            }

                            // Attendance
                            let { data: aData, error: aError } = await supabaseClient.from('attendance').select('*');
                            if (!aError && aData) setAttendance(aData);

                            // Messages
                            let { data: mData, error: mError } = await supabaseClient.from('messages').select('*');
                            if (!mError && mData) setMessages(mData);

                        } catch (err) {
                            console.error("Fetch Error:", err);
                        }
                    };
                    fetchData();
                    
                    const poll = setInterval(fetchData, 5000);
                    return () => clearInterval(poll);
                }
            }, [user, isOnline, supabaseClient]);

            const showToast = (msg, type = 'success') => setToast({ message: msg, type });
            const closeToast = () => setToast(null);

            if (!user) return (
                <>
                    {toast && <Toast message={toast.message} type={toast.type} onClose={closeToast} />}
                    <Login onLogin={setUser} users={users} showToast={showToast} />
                </>
            );

            return (
                <div className="min-h-screen bg-[#f0f4f8] text-gray-800">
                    {toast && <Toast message={toast.message} type={toast.type} onClose={closeToast} />}
                    <div className="fixed top-6 left-6 z-40">
                        <div className="bg-white/80 backdrop-blur-md rounded-full shadow-[0_8px_30px_rgb(0,0,0,0.12)] pl-4 pr-2 py-2 flex items-center gap-3 border border-white/50 transition hover:scale-105">
                            <span className="font-bold text-indigo-600 flex items-center gap-2 text-sm"><Icons.Smile className="w-5 h-5"/> SmartAttend</span>
                            {isOnline ? (
                                <span className="bg-green-100 text-green-700 text-[10px] px-2 py-0.5 rounded-full font-bold border border-green-200 flex items-center gap-1"><div className="w-1.5 h-1.5 rounded-full bg-green-500 animate-pulse"></div> Online</span>
                            ) : (
                                <span className="bg-gray-100 text-gray-500 text-[10px] px-2 py-0.5 rounded-full font-bold border border-gray-200 flex items-center gap-1"><div className="w-1.5 h-1.5 rounded-full bg-gray-400"></div> {onlineStatusMsg}</span>
                            )}
                            <div className="h-4 w-px bg-gray-300"></div>
                            <button onClick={() => setUser(null)} className="bg-gray-100 text-gray-500 p-2 rounded-full hover:bg-red-50 hover:text-red-500 transition"><Icons.LogOut className="w-4 h-4"/></button>
                        </div>
                    </div>
                    <div className="pt-24 px-4 pb-10">
                        {user.role === 'siswa' && <SiswaDashboard user={user} users={users} attendance={attendance} setAttendance={setAttendance} showToast={showToast} isActive={isOnline} supabase={supabaseClient} />}
                        {user.role === 'guru' && <GuruDashboard user={user} users={users} attendance={attendance} setAttendance={setAttendance} messages={messages} showToast={showToast} isActive={isOnline} supabase={supabaseClient} />}
                        {user.role === 'admin' && <AdminDashboard users={users} setUsers={setUsers} attendance={attendance} messages={messages} setMessages={setMessages} showToast={showToast} isActive={isOnline} supabase={supabaseClient} />}
                    </div>
                </div>
            );
        };

        ReactDOM.createRoot(document.getElementById('root')).render(<App />);
    </script>
</body>
</html>
